
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>User: Y-Ex, MBA</title>

    <!-- Bootstrap core CSS -->
    <link href="../scripts/css/bootstrap.min.css" rel="stylesheet">
    <link href="../scripts/css/jasny-bootstrap.min.css" rel="stylesheet">
    
    <style>
        .profile_image{
            width:232px;
            position: relative;
        }
        .profile_image:hover{
            border: 1px solid #666;
            cursor: pointer;
        }
        
         .bannerChangeImage{
            position: absolute; 
            color: #fff; 
            top:0; 
            padding: 0px 5px 0px 5px; 
            background: green;
            display: none;
         }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><p class="navbar-text"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Logged in as User</p></li>
            <li><a href="../server/user_logout.php">Log out</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div style='margin-bottom: 40px;'>
        <!-- TABLE TO DISLAY CURRENT STATUS OF OPENING SUBJECT -->
        <table id='tableStatus' style='width: 100%; min-width: 400px;'>
            <tr>
                <td style='width: 250px; vertical-align:top;'>
                    <div style='font-family: Tahoma; margin-top: 5px; margin-left: 5px;'>
                        <div class='profile_image' data-toggle="modal" data-target="#modalUploadImage">
                            <image  src='../images/ozoraT.png' style='width:230px; height:230px;' />
                            <div class='bannerChangeImage'>Change your image</div>
                        </div>
                        <span style='font-size: 30px; color: #333; line-height:40px; width: 100%; display: block;' class='studentName'>โอโซระ ซึบาซะ</span>
                        <span style='font-size: 18px; color: #666; margin-left: 4px;' class='studentId'>5682221826</span>
                        <br>
                        <span style='font-size: 14px; color: #666; margin-left: 4px; margin-top:4px' data-toggle="modal" data-target="#modalChangePassword"><a href='#'>Change Password</a></span>
                    </div>
                    <div style='padding:10px;'>
                        <input type='button' class="btn btn-success" onClick='moveToRegisterPage();' value='Register' />
                    </div>
                </td>
                <td style='vertical-align: top; padding: 5px;'>
                    <div style='border: 1px solid #efefef;'>
                        <div style='color:#777; background-color: #e7e7e7; border-color: #e1e1e1;padding: 10px;'>
                          <h3 class="panel-title">สถานะของวิชาเลือก</h3>
                        </div>        
                        <div class="panel-body" id='appendSubjectStatus'>
                        
                        </div>
                    </div>
                </td>
            </tr>
        </table>
         
        <!-- TABLE TO DISPLAY RESULT OF REGISTER -->
        <table id='tableResult' style='width: 100%; display:none; min-width: 400px;'>
            <tr>
                <td style='width: 250px; vertical-align:top;'>
                    <div style='font-family: Tahoma; margin-top: 5px; margin-left: 5px;'>
                        <div class='profile_image' data-toggle="modal" data-target="#modalUploadImage">
                            <image  src='../images/ozoraT.png' style='width:230px; height:230px;' />
                            <div class='bannerChangeImage'>Change your image</div>
                        </div>
                        <span style='font-size: 30px; color: #333; line-height:40px; width: 100%; display: block;' class='studentName'>โอโซระ ซึบาซะ</span>
                        <span style='font-size: 18px; color: #666; margin-left: 4px;' class='studentId'>5682221826</span>
                        <br>
                        <span style='font-size: 14px; color: #666; margin-left: 4px; margin-top:4px' data-toggle="modal" data-target="#modalChangePassword"><a href='#'>Change Password</a></span>
                    </div>
                </td>
                <td style='vertical-align: top; padding: 5px;'>
                    <div style='border: 1px solid #efefef;'>
                        <div style='color:#777; background-color: #e7e7e7; border-color: #e1e1e1;padding: 10px;'>
                          <h3 class="panel-title">สรุปผลการเลือกวิชา</h3>
                        </div>        
                        <div class="panel-body" id="appendSubjectResult">
                        
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        
        <!-- TABLE NO DATA -->
        <table id='tableNodata' style='width: 100%; display:none; min-width: 400px;'>
            <tr>
                <td style='width: 250px; vertical-align:top;'>
                    <div style='font-family: Tahoma; margin-top: 5px; margin-left: 5px;'>
                        <div class='profile_image' data-toggle="modal" data-target="#modalUploadImage">
                            <image  src='../images/ozoraT.png' style='width:230px; height:230px;' />
                            <div class='bannerChangeImage'>Change your image</div>
                        </div>
                        <span style='font-size: 30px; color: #333; line-height:40px; width: 100%; display: block;' class='studentName'>โอโซระ ซึบาซะ</span>
                        <span style='font-size: 18px; color: #666; margin-left: 4px;' class='studentId'>5682221826</span>
                        <br>
                        <span style='font-size: 14px; color: #666; margin-left: 4px; margin-top:4px' data-toggle="modal" data-target="#modalChangePassword"><a href='#'>Change Password</a></span>
                    </div>
                </td>
                <td style='vertical-align: top; padding: 5px;'>
                    <div style='border: 1px solid #efefef;'>
                        <div style='color:#777; background-color: #e7e7e7; border-color: #e1e1e1;padding: 10px;'>
                          <h3 class="panel-title">ยังไม่มีวิชาเลือกเปิดสำหรับรุ่นนี้</h3>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        
        <!-- MODAL UPLOAD IMAGE -->
        <div class="modal fade" id="modalUploadImage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel" style='font-weight:bold'>Upload your image</h4>
              </div>
              <div class="modal-body" style='text-align:center'>
                    <div class="fileinput fileinput-new" data-provides="fileinput">
                      <div class="fileinput-new thumbnail" style="width: 230px; height: 230px; background:#efefef">
                      W230 x H230
                      </div>
                      <div class="fileinput-preview fileinput-exists thumbnail" style="max-width: 230px; max-height: 230px;"></div>
                      <div>
                        <span class="btn btn-default btn-file"><span class="fileinput-new">Select image</span><span class="fileinput-exists">Change</span><input type="file" name="..."></span>
                        <a href="#" class="btn btn-default fileinput-exists" data-dismiss="fileinput">Remove</a>
                      </div>
                    </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Confirm</button>
              </div>
            </div>
          </div>
        </div>

        <!-- MODAL CHANGE PASSWORD -->
        <div class="modal fade" id="modalChangePassword" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel" style='font-weight:bold'>Change Password</h4>
              </div>
              <div class="modal-body" style='text-align:center'>
                <div class="alert alert-success" role="alert" id="updatePassword-success" style="display:none; margin-top: 10px; text-align: center;">ได้รับการแก้ไข password แล้ว</div>
                <div class="alert alert-danger" role="alert" id="updatePassword-fail" style="display:none; margin-top: 10px; text-align: center;">ไม่สามารถแก้ password ได้ เกิดปัญหาขึ้นในระบบ</div>
                <div>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Current Password" required>
                    <br>
                    <input type="password" id="newPassword" class="form-control" placeholder="New Password" required>
                    <br>
                    <input type="password" id="newPasswordRepeat" class="form-control" placeholder="New Password Again" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" onClick="updatePasswordExecuted();">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div><!-- body item-->
      <hr>
      <footer>
        <div>
            We are the same <span style='color:#cb70d7; font-weight: bold;'>CHULA</span> so let talk together.
        </div>
        <!--
        <button onClick='toggleUserState(1);'>[De-Active Semester] NoSubject test</button><br />
        <button onClick='toggleUserState(2);'>[Active Semester] Done test</button><br />
        <button id='randomRegister' onClick='randomProgress(); toggleUserState(3);'>[Active Semester] Random test</button>
        -->
      </footer>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../scripts/js/jquery.min.js"></script>
    <script src="../scripts/js/sha1.js">/* SHA-256 JavaScript implementation */</script>
    <script src="../scripts/js/bootstrap.min.js"></script>
    <script src="../scripts/js/jasny-bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../scripts/js/ie10-viewport-bug-workaround.js"></script>
    
    <script>
        var student_id = '';

        $(document).ready(function () {
            $('.profile_image').hover( 
                function(){
                        $('.bannerChangeImage').css('display','block');
                }, 
                function(){
                        $('.bannerChangeImage').css('display','none');
                }
            );
            //
            getUserInformation( window.location.search.split('?id=')[1] );
        });
        //
        function getUserInformation( id ){
            var urlStr = window.location.origin + '/server/user_api.php/api/v1/account/list';
            var jsonObj = {
                'student_id' : id
            };
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: urlStr,
                data: JSON.stringify( jsonObj ),
                dataType: 'json',
                contentType: "text/plain; charset=UTF-8",
                success: function(data, textStatus, jqXHR){
                        $('.studentName').each(function(){
                            $(this).text(data[0].userdata[0].name + ' ' + data[0].userdata[0].lastname);
                        });
                        $('.studentId').each(function(){
                            $(this).text(data[0].userdata[0].student_id);
                        });
                        student_id = data[0].userdata[0].student_id;
                        //
                        toggleUserState( data[1].semester_state );
                        //
                        if( data[1].semester_state === 1 ){
                            //Activate Open for Register [STATUS]
                            var bodySubject = document.getElementById('appendSubjectStatus');
                            for(var i=0; i< data[2].subjectlist.length; i++)
                            {
                                var accordionElement = document.createElement('div');
                                accordionElement.id = 'accordion';
                                accordionElement.style.marginBottom = '5px';
                                
                                var aElement = document.createElement('a');
                                aElement.setAttribute('data-toggle', 'collapse');
                                aElement.setAttribute('data-parent', '#accordion');
                                aElement.setAttribute('href', '#collapse' + i );
                                aElement.style.fontSize = '18px';
                                aElement.innerHTML = data[2].subjectlist[i].name ;
                                accordionElement.appendChild( aElement );
                                
                                var collapseElement = document.createElement('div');
                                collapseElement.id = 'collapse' + i ;
                                collapseElement.className = 'panel-collapse collapse';
                                accordionElement.appendChild( collapseElement );
                                
                                var descriptionElement = document.createElement('div');
                                descriptionElement.style.padding = '5px';
                                descriptionElement.style.border = '1px solid #efefef';
                                descriptionElement.innerHTML = data[2].subjectlist[i].description;
                                collapseElement.appendChild( descriptionElement );
                                
                                //PROGRESS
                                var progressElement = document.createElement('div');
                                progressElement.className = 'progress';
                                accordionElement.appendChild( progressElement );
                                
                                var progressSubElement = document.createElement('div');
                                progressSubElement.id = 'progress' + i;
                                progressSubElement.className = 'progress-bar progress-bar-striped active';
                                progressSubElement.setAttribute('role', 'progressbar');
                                progressSubElement.setAttribute( 'aria-valuenow', data[2].subjectlist[i].studentcount );
                                progressSubElement.setAttribute('aria-valuemin', data[2].subjectlist[i].minstudent );
                                progressSubElement.setAttribute('aria-valuemax', data[2].subjectlist[i].maxstudent );
                                
                                var percentValue = (data[2].subjectlist[i].studentcount * 100)/data[2].subjectlist[i].maxstudent;
                                progressSubElement.style.width = percentValue + '%';
                                progressSubElement.innerHTML = data[2].subjectlist[i].studentcount + '/' + data[2].subjectlist[i].maxstudent;
                                //
                                if( percentValue >= 80 && percentValue < 100 ){
                                    progressSubElement.className = progressSubElement.className + ' progress-bar-warning';
                                }
                                else if( percentValue >= 100){
                                    progressSubElement.className = progressSubElement.className + ' progress-bar-danger';
                                }
                                else{
                                    progressSubElement.className = progressSubElement.className + ' progress-bar-success';
                                }
                                progressElement.appendChild( progressSubElement );
                                bodySubject.appendChild( accordionElement );
                            }    
                        }
                        else if( data[1].semester_state === 2 ){
                            //Activate Open for Register [SUMMARY]
                            var bodySubject = document.getElementById('appendSubjectResult');
                            for(var i=0; i< data[2].subjectlist.length; i++)
                            {
                                var accordionElement = document.createElement('div');
                                accordionElement.id = 'accordion';
                                accordionElement.style.marginBottom = '5px';
                                
                                var aElement = document.createElement('a');
                                aElement.setAttribute('data-toggle', 'collapse');
                                aElement.setAttribute('data-parent', '#accordion');
                                aElement.setAttribute('href', '#collapse' + i );
                                aElement.style.fontSize = '18px';
                                aElement.innerHTML = data[2].subjectlist[i].name ;
                                accordionElement.appendChild( aElement );
                                
                                var collapseElement = document.createElement('div');
                                collapseElement.id = 'collapse' + i ;
                                collapseElement.className = 'panel-collapse collapse';
                                accordionElement.appendChild( collapseElement );
                                
                                var descriptionElement = document.createElement('div');
                                descriptionElement.style.padding = '5px';
                                descriptionElement.style.border = '1px solid #efefef';
                                descriptionElement.innerHTML = data[2].subjectlist[i].description;
                                collapseElement.appendChild( descriptionElement );
                                
                                bodySubject.appendChild( accordionElement );
                            }
                        }
                        else{
                            //No Data
                        }     
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert('get user information error: ' + textStatus);
                }
            });
        };
        //
        
        function toggleUserState( value ){     
            if( value === 1 ){
                //STATUS
                $('#tableStatus').fadeIn(300);
                $('#tableResult').fadeOut(10);
                $('#tableNodata').fadeOut(10);
            }
            else if( value === 2 ){
                //RESULT
                $('#tableResult').fadeIn(300);
                $('#tableStatus').fadeOut(10);
                $('#tableNodata').fadeOut(10);
            }
            else {
                //NO DATA
                $('#tableNodata').fadeIn(300);
                $('#tableStatus').fadeOut(10);
                $('#tableResult').fadeOut(10);
            }
        }
        
        function randomProgress(){
            var arrayResult = [];
            var numberOfSubject = 3;
            //
            for( var i=0; i < numberOfSubject; i++){
                var result = Math.floor(Math.random() * 150 ) + 1 ;
                arrayResult.push( result );
                //
                var progressId = '#progress' + (i + 1);
                $(progressId).html( result + '/100');
                $(progressId).removeClass( 'progress-bar-success' );
                $(progressId).removeClass( 'progress-bar-warning' );
                $(progressId).removeClass( 'progress-bar-danger' );
                //
                if( result >= 80 && result < 100 ){
                    $(progressId).addClass( 'progress-bar-warning' );
                }
                else if( result >= 100){
                    $(progressId).addClass( 'progress-bar-danger' );
                }
                else{
                    $(progressId).addClass( 'progress-bar-success' );
                }
                $(progressId).attr('aria-valuenow', result);
                $(progressId).css('width', result > 100 ? '100%': result + '%' );
            }
        }
        
        function moveToRegisterPage(){
            window.location.href ="user_register.html?id=" + window.location.search.split('?id=')[1];
        }

        function updatePasswordExecuted() {
            var currentPassword = $('#currentPassword').val();
            var newPassword = $('#newPassword').val();
            var newPasswordRepeat = $('#newPasswordRepeat').val();
            var urlStrCheckPass = window.location.origin + '/server/user_api.php/api/v1/account/checkPass';
            var urlStrUpdatePass = window.location.origin + '/server/user_api.php/api/v1/account/updatePass';
            var secretMessage = '';
            var hashPassword = '';
            var jsonObj = {};

            if (newPassword !== newPasswordRepeat) {
                console.log('new password mismatched');
                document.getElementById('updatePassword-fail').innerHTML = 'Password ที่กรอกใหม่ไม่ตรงกัน';
                document.getElementById('updatePassword-success').style.display = 'none';
                document.getElementById('updatePassword-fail').style.display = 'block';
                return;
            }

            secretMessage = student_id + currentPassword;
            hashPassword = Sha1.hash(secretMessage);

            jsonObj = {
                'hashPassword' : hashPassword
            };

            //send check old password
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: urlStrCheckPass,
                data: JSON.stringify( jsonObj ),
                dataType: 'json',
                contentType: "text/plain; charset=UTF-8",
                success: function(data, textStatus, jqXHR){
                    if (data.cnt == 1) {
                        secretMessage = student_id + newPassword;
                        hashPassword = Sha1.hash(secretMessage);

                        jsonObj = {
                            'hashPassword' : hashPassword
                        };

                        //send update password
                        $.ajax({
                            type: 'POST',
                            contentType: 'application/json',
                            url: urlStrUpdatePass,
                            data: JSON.stringify( jsonObj ),
                            dataType: 'json',
                            contentType: "text/plain; charset=UTF-8",
                            success: function(data, textStatus, jqXHR){
                                document.getElementById('updatePassword-success').style.display = 'block';
                                document.getElementById('updatePassword-fail').style.display = 'none';
                            },
                            error: function(jqXHR, textStatus, errorThrown){
                                document.getElementById('updatePassword-fail').innerHTML = 'ไม่สามารถแก้ password ได้ เกิดปัญหาขึ้นในระบบ';
                                document.getElementById('updatePassword-success').style.display = 'none';
                                document.getElementById('updatePassword-fail').style.display = 'block';
                            }
                        });
                    } else {
                        document.getElementById('updatePassword-fail').innerHTML = 'กรอก Password ผิด คุณไม่สามารถแก้ไขได้';
                        document.getElementById('updatePassword-success').style.display = 'none';
                        document.getElementById('updatePassword-fail').style.display = 'block';
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    document.getElementById('updatePassword-fail').innerHTML = 'ไม่สามารถแก้ password ได้ เกิดปัญหาขึ้นในระบบ';
                    document.getElementById('updatePassword-success').style.display = 'none';
                    document.getElementById('updatePassword-fail').style.display = 'block';
                }
            });
            
        }
        
    </script>
  </body>
</html>
