
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>การลงทะเบียนวิชาเรียน: Y-Ex, MBA</title>

    <!-- Bootstrap core CSS -->
    <link href="../scripts/css/bootstrap.min.css" rel="stylesheet">
    <link href="../scripts/css/jasny-bootstrap.min.css" rel="stylesheet">
    <link href="../scripts/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="../scripts/css/jquery-ui.min.css" rel="stylesheet" >
    <link href="../scripts/css/jquery.datetimepicker.css" rel="stylesheet" type="text/css" />

    <!-- Custom styles for this template -->
    <link href="../scripts/css/admin_template.css" rel="stylesheet">
    
    <style>
        #sortableMain {
            list-style-type: none;
            text-align: left;
            background: #ddd;
            padding: 0px;
            position: relative;
            min-height: 26px;
            vertical-align: top;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        #sortableMain li{
            position: relative;
        }
        
        ul[id*='sortable']:not(#sortableMain) {
            width: 300px;
            min-height: 40px;
            list-style-type: none;
            margin-top: 2px;
            background: #ddd;
            text-align: left;
            margin-left: 1px;
            position: relative;
        }
        
        ul[id*='sortable'] li {
            font-size: 1.2em;
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #000;
            width: 300px;
            margin-left: 1px;
            padding: 5px;
            color: green;
            word-wrap: break-word;
        }
        
        li:hover{
            cursor: default;
        }
        
        tr{
            vertical-align: top;
            text-align: center;
        }
        
        .step2div{
            background: #f6f6f6; 
            width: 100%; 
            border: 1px solid #c8c8c8;
            min-width: 1000px;
            margin-bottom: 5px;
        }
        
        #step2Area div.btn-group.bootstrap-select{
            width: 100px;
        }
        
        #pickerAread div.btn-group.bootstrap-select{
            width: auto;
        }
        
        .datetimePicker{
            width: 140px;
            display: inline-block;
            margin-left: 10px;
            margin-right: 10px;
        }
    </style>
    
  </head>

  <body>

    <div class="topnavbar">
        <div class="topnavbar-right">
          <ul>
            <li>
              <p class="topnavbar-text"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Logged in as Admin</p>
            </li>
            <li>
              <p class="topnavbar-text"><a href="../server/admin_logout.php">Log out</a></p>
            </li>
          </ul>
        </div>
    </div>

    <div class="navmenu navmenu-default navmenu-fixed-left offcanvas">
      <a class="navmenu-brand" href="#">Y-Ex, MBA</a>
      <ul class="nav navmenu-nav">
        <li><a href='admin_importdata.html'>ระบบ Import ข้อมูลวิชาเรียน</a></li>
        <li><a href='admin_importstudent.html'>ระบบ Import ข้อมูลนิสิต</a></li>
        <li class='active'><a href='#'>การลงทะเบียนวิชาเรียน</a></li>
        <li><a href="admin_displayresult.html">แสดงผลการเลือก</a></li>
      </ul>
      <ul class="nav navmenu-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advance<b class="caret"></b></a>
          <ul class="dropdown-menu navmenu-nav">
            <li><a href="admin_account.html">จัดการสิทธิ์การเข้าถึงระบบ Admin</a></li>
            <li><a href="admin_datareader.html">ดูข้อมูลใน Database</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navmenu-nav">
        <li><a href="../index.html"><font color="red">ออกจากระบบ</font></a></li>
      </uL>
    </div>

    <div class="navbar navbar-default navbar-fixed-top">
      <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target=".navmenu" data-canvas="body">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>


    <div class="container">

      <ol class="breadcrumb">
        <li><a href="admin_dashboard.html">Home</a></li>
        <li class="active">การลงทะเบียนวิชาเรียน<li>
      </ol>

      <div class="starter-template">
        <h1>การลงทะเบียนวิชาเรียน</h1>
        <p>
          โปรดเลือกรุ่นของนิสิตและเทอมที่ต้องการอัพเดทวิชาเลือก
        </p>
      </div>
      <div style='background:#f6f6f6; width: 100%; border: 1px solid #c8c8c8; text-align: center;'>
            <div style='padding:10px;'>
                <div style='padding: 5px 5px 5px 5px; margin-right: 5px; display: inline-block;'>
                    <select id='studentYear' class="selectpicker">
                        <option value="" selected disabled>รุ่นนิสิต</option>
                    </select>
                </div> 
                <div style='padding: 5px 5px 5px 5px; margin-right: 5px; display: inline-block;'>
                    <select id='studentSemester' class="selectpicker">
                        <option value="" selected disabled>เทอม</option>
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                    </select>
                </div> 
                <input style='margin-left: 8px;' type='button' class="btn btn-success" onClick='getSubjectList();' value='Update' />
            </div>
         </div>
      <hr>
      
      <div id='step1Area' style='line-height: 26px; min-width: 600px; display: none; text-align: center;'>
            <table style='margin-left: auto; margin-right: auto;'>
                <tr>
                    <td><h4>วิชาเลือกทั้งหมด</h4></td>
                    <td style='width: 40px;'></td>
                    <td><h4>วิชาเลือกสำหรับเทอมนี้<span id='countSelected'>(0)</span></h4></td>
                </tr>
                <tr>
                    <td>
                        <ul id="sortableMain" class="connectedSortable">
                        </ul>
                    </td>
                    <td></td>
                    <td>
                        <div id='selectedZone' style='display: inline-block; background: #efefef; display: inline-block; color: #666;'></div>
                    </td>
                </tr>
            </table>
            <div style='margin-top: 20px;'>
            <input type='button' class="btn btn-default" style="margin-right:5px;" onClick='clearFunction();' value='Clear' />
            <input type='button' class="btn btn-default" style="margin-right:5px;" onClick='selectAllFunction();' value='Select All' />
                <input type='button' class="btn btn-primary" onClick='toggleToSteps(2)' value='Next' />
            </div>
      </div>
        
      <div id='step2Area' style='line-height: 26px; display:none; text-align: center;'>
            <div></div>
            <div style='display: inline-block; background: #efefef; color: #666; margin-top: 10px;'>
                        - หากเราใส่ค่าในช่อง '#สูงสุด' หรือ '#ขั้นต่ำ' จะถูกนำมาใช้เป็นเงื่อนไขในการเปิดสอนรายวิชา
            </div>
            <div class="alert alert-info" role="alert" style='padding:10px; margin-top: 10px;' id='pickerAread'>
                <div style='display: inline-block; color: #31708f; font-weight: bold; margin-right: 5px;'>เงื่อนไขของเทอม:</div>
                <div style='display:inline-block'>
                    <input type='text' class='form-control' style='width: 110px' placeHolder='หน่วยกิจขั้นต่ำ' id='minUnitTerm' onkeypress="return isNumber(event)"/>
                </div>
                <div style='display:inline-block'>
                    <input type='text' class='form-control' style='width: 110px' placeHolder='หน่วยกิจสูงสุด' id='maxUnitTerm' onkeypress="return isNumber(event)" />
                </div>
                <select class='selectpicker' id='methodPicker'>
                    <option value='N/A' selected disabled>วิธีที่ใช้ตัดสินกรณีไม่ลงตัว</option>
                </select>
                <div style="margin-left: 15px; margin-top: 2px; vertical-align: middle; display:inline-block;"><input type="checkbox" id='semesterState' value="1"><span style="margin-left: 5px; font-weight: bold;">Active?</span>
                 </div>
                 <div id='manageActive' style='display:none; margin-top:8px; background-color: #efefef;'>
                    <div class="radio" style='display:inline-block; margin-left: 20px;'>
                        <input type="radio" style='margin-top:6px;' name="optionsRadios" value="option1" checked>
                        Now
                    </div>
                    <div class="radio" style='display:inline-block; margin-left: 30px;'>
                        <input type="radio" style='margin-top:6px;' name="optionsRadios" value="option2">
                        By Schedule
                        <div style='display:none; margin-left:10px;'>
                                        วันเริ่มลงทะเบียน:<input type="text" class="datetimePicker form-control" value="" id="openPeriod"/>
                                        วันสุดท้ายของการลงทะเบียน:<input type="text" class="datetimePicker form-control" value="" id="closePeriod"/>
                        </div>
                    </div>
                 </div>
            </div>
            <div style='margin-top: 20px;' id='buttonArea'>
                <input  type='button' class="btn btn-primary" onClick='toggleToSteps(1)' value='Back' />
                <input style='margin-left: 10px;' type='button' class="btn btn-success" onClick='onSubmitSubject();' value='Submit' />
            </div>
            <div class="alert alert-success" role="alert" id="import-success" style="display:none; margin-top: 20px;"><b>SUCCESS</b> ทำการ Enrollment เรียบร้อยแล้ว</div>
            <div class="alert alert-warning" role="alert" id="import-warning" style="display:none; margin-top: 20px;"><b>WARNING</b> Enrollment Error</div>
            <div style='display: none; margin-top: 20px;' id='reloadAgain'>
                <input  type='button' class="btn btn-primary" value='Enrollment Again?' onClick='location.reload();'/>
            </div>
      </div>
      
      <hr>
      <footer class="footer">
          <div style='margin-bottom: 60px'>
            We are the same <span style='color:#cb70d7; font-weight: bold;'>CHULA</span> so let talk together.
          </div>
        </footer>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../scripts/js/jquery.min.js"></script>
    <script src="../scripts/js/jquery-ui.min.js"></script>
    <script src="../scripts/js/jquery.datetimepicker.js"></script>
    <script src="../scripts/js/bootstrap.min.js"></script>
    <script src="../scripts/js/jasny-bootstrap.min.js"></script>    
    <script src="../scripts/js/bootstrap-select.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../scripts/js/ie10-viewport-bug-workaround.js"></script>

    <script>
        var subjectList = [];
        var subjectListId = [];
        var subjectListObj = {};
        var classOfSemesterObj = {};

        $(document).ready(function () {
            //ACTIVATE DDL
            $('.selectpicker').selectpicker();
            //GET STUDENTCLASS
            getStudentClassList();
            //GET PICKMETHOD
            getPickMethodList();
            //DATETIME PICKER
            $('#openPeriod').datetimepicker();
            $('#closePeriod').datetimepicker();
            
            $('#semesterState').change(function(){
                if( $('#semesterState:checked').length === 1 ){
                    $('#manageActive').fadeIn(300);
                }
                else{
                    $('#manageActive').fadeOut(300);
                }
            });
            
            //MANAGE ACTIVE NOW/SCHEDULE
            $('input[name="optionsRadios"]').change(function(){
                if( $(this).attr('value') === 'option1' ){
                    $('#closePeriod').parent().fadeOut(300);
                    $('input[value="option2"]').css('margin-top', '6px');
                }else{
                    $('#closePeriod').parent().fadeIn(300);
                    $('#closePeriod').parent().css('display','inline-block');
                    $('input[value="option2"]').css('margin-top', '10px');
                }
            });
        });
        
        //VALIDATION
        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }
        
        //WHEN SELECT CLASS FROM CRITERIA
        function queryFromCriteria(){
            $('#sortableMain').empty();
            $('#selectedZone').empty();

            for(var i =0; i < subjectList.length; i++){
                var tmpLiElement = document.createElement('li');
                tmpLiElement.innerHTML = '[' + $.trim(subjectListObj[i].subject_id) + ']-' +subjectList[ i ];
                tmpLiElement.setAttribute('tmpSelected', subjectListObj[ i ].selected);
                tmpLiElement.setAttribute('subjectId', $.trim(subjectListObj[i].subject_id));
                $('#sortableMain').append( tmpLiElement );
            }
            //
            //ADD <UL> LANDING ITEMS
            var selectedZoneElement = document.getElementById('selectedZone');
            var initialNum = 5;
            for( var i=0; i< initialNum; i++){
                var tmpUIElement =  document.createElement('ul');
                tmpUIElement.id = 'sortable' + i;
                tmpUIElement.className = 'connectedSortable';
                tmpUIElement.style.padding = '0px';
                tmpUIElement.style.marginBottom = '0px';
                selectedZoneElement.appendChild( tmpUIElement );
            }
            
            //BIND DRAG/SORABLE EVENT
            $( '.connectedSortable' ).sortable({
                connectWith: ".connectedSortable",
                stop: function( event, ui) {
                    //SUPPORT SWAP
                    var parentElement = event.toElement.parentElement;
                    if( parentElement.childElementCount > 1 && parentElement.id !== 'sortableMain' ){
                        for( var i=0; i< parentElement.childElementCount; i++ ){
                            if( event.toElement.innerHTML !== parentElement.children[ i ].innerHTML ){
                                event.target.appendChild( parentElement.children[i] );
                                break;
                            }
                        }
                    }
                    
                    var countSelectedItem = countSelectedItemText();
                    if( $('#selectedZone').children().length <= countSelectedItem ){
                        var tmpUIElement =  document.createElement('ul');
                        tmpUIElement.id = 'sortable' + (countSelectedItem+1) ;
                        tmpUIElement.className = 'connectedSortable';
                        tmpUIElement.style.padding = '0px';
                        tmpUIElement.style.marginBottom = '0px';
                        $('#selectedZone').append( tmpUIElement );
                        //ACTIVATE FOR NEW ITEM ADDED
                        $( '.connectedSortable' ).sortable({
                            connectWith: ".connectedSortable"
                        }).disableSelection();
                    }
                },
                receive: function(){
                    countSelectedItemText();
                }
            }).disableSelection();
            //
            $('#step1Area').fadeIn(300);
            //
            //MOVE SELECTED TO RIGHT PANEL           
            var indexMove = 0;
            while( indexMove < $('#sortableMain').children().length){
                if( $('#sortableMain').children()[ indexMove ].getAttribute('tmpselected') === "1" ){                    
                    //
                    var countSelectedItem = countSelectedItemText();
                    if( $('#selectedZone').children().length <= countSelectedItem ){
                        var tmpUIElement =  document.createElement('ul');
                        tmpUIElement.id = 'sortable' + (countSelectedItem+1) ;
                        tmpUIElement.className = 'connectedSortable';
                        tmpUIElement.style.padding = '0px';
                        tmpUIElement.style.marginBottom = '0px';
                        $('#selectedZone').append( tmpUIElement );
                        //ACTIVATE FOR NEW ITEM ADDED
                        $( '.connectedSortable' ).sortable({
                            connectWith: ".connectedSortable"
                        }).disableSelection();
                    }
                    //
                    for( var i=0; i < $('#selectedZone').children().length; i++ ){
                        if( ! $('#selectedZone').children()[i].hasChildNodes() ){
                            $('#selectedZone').children()[i].appendChild( $('#sortableMain').children()[ indexMove ] );
                            break;
                        }
                    }//for
                    indexMove  = 0;
                }else{
                    indexMove++;
                }
            }
        }
        
        //COUNT <LI> FOR MANAGE ADDTIONAL <UL> LANDING ITEMS
        function countSelectedItemText(){
            var countSelectedItem = 0;
            $('#selectedZone').children().each(function(){
                if( $(this).children().length > 0 ){
                    countSelectedItem++;
                }
            });
            //UPDATE NUMBER OF SELECTION
            $('#countSelected').text( '(' + countSelectedItem +')' );
            return countSelectedItem;
        }
        
        //SWITCHER BETWEEN 1/2
        function toggleToSteps( value ){
            if( value === 1 ){
                var resultConfirm = confirm("Please note that if you press 'OK' the data that you changing will be revert to data from database because you still not submit.");
                if( resultConfirm === true ){            
                    //REMOVE CURRENT EXISTING ITEMS
                    $('#step2Area').children().first().empty();
                    //
                    $('#step1Area').fadeIn(300);
                    $('#step2Area').fadeOut(10);
                }
            }
            else if( value === 2 ){
                if( countSelectedItemText() === 0 ){
                    alert( 'Please select subjects first.' );
                    return;
                }
                var index = 0;
                //GENERATE ITEMS FOLLOW STEP-1
                $('#selectedZone').children().each(function(){
                    if( $(this).children().length > 0 ){
                        var tmpPersistObj = {};
                        for(var i=0; i< subjectListObj.length; i++){
                            if( $.trim(subjectListObj[ i ].subject_id) === $(this).children()[0].getAttribute('subjectId') ){
                                tmpPersistObj = subjectListObj[ i ];
                            }
                        }
                        //
                        var itemDiv = document.createElement('div');
                        itemDiv.id = 'item' + index;
                        itemDiv.className = 'step2div';
                        $('#step2Area').children().first().append( itemDiv );
                        //TEXT SUBJECT
                        var itemDivTextSubject = document.createElement('div');
                        itemDivTextSubject.id = 'item' + index + '_subject';
                        itemDivTextSubject.style.display = 'inline-block';
                        itemDivTextSubject.style.marginRight = '10px';
                        itemDivTextSubject.style.width = '200px';
                        itemDivTextSubject.style.wordWrap = 'break-word';
                        itemDivTextSubject.style.verticalAlign = 'middle';
                        itemDivTextSubject.style.textAlign = 'left';
                        itemDivTextSubject.innerHTML = $(this).children().text();
                        itemDiv.appendChild( itemDivTextSubject )
                        itemDiv.setAttribute('subjectId', $(this).children()[0].getAttribute('subjectId'));
                        //DDL DATE
                        var itemDivSubject = document.createElement('div');
                        itemDivSubject.style.display = 'inline-block';
                        itemDivSubject.style.marginRight = '15px';
                        itemDiv.appendChild( itemDivSubject );
                        var itemDivSubjectSelect = document.createElement('select');
                        itemDivSubjectSelect.className = 'selectpicker';
                        itemDivSubjectSelect.id = 'item' + index + '_date';
                        itemDivSubject.appendChild( itemDivSubjectSelect );
                        //
                        var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        var tmpPlaceHolder = document.createElement('option');
                        tmpPlaceHolder.setAttribute('value', 'N/A');
                        tmpPlaceHolder.setAttribute('selected','true');
                        tmpPlaceHolder.setAttribute('disabled','true');
                        tmpPlaceHolder.innerHTML = 'วันที่สอน';
                        itemDivSubjectSelect.appendChild( tmpPlaceHolder );
                        for(var i=0; i < days.length; i++){
                            var tmpOption = document.createElement('option');
                            tmpOption.setAttribute('value', i );
                            tmpOption.innerHTML = days[i];
                            if( tmpPersistObj.dayofweek === i ){
                                tmpOption.setAttribute('selected', true);
                            }
                            itemDivSubjectSelect.appendChild( tmpOption );
                        }
                        //DDL TIMEs
                        var itemDivSubject = document.createElement('div');
                        itemDivSubject.style.display = 'inline-block';
                        itemDiv.appendChild( itemDivSubject );
                        var itemDivSubjectSelect = document.createElement('select');
                        itemDivSubjectSelect.className = 'selectpicker';
                        itemDivSubjectSelect.id = 'item' + index + '_time';
                        itemDivSubject.appendChild( itemDivSubjectSelect );
                        //
                        var times = ['เช้า', 'บ่าย', 'เย็น'];
                        var tmpPlaceHolder = document.createElement('option');
                        tmpPlaceHolder.setAttribute('value', 'N/A');
                        tmpPlaceHolder.setAttribute('selected','true');
                        tmpPlaceHolder.setAttribute('disabled','true');
                        tmpPlaceHolder.innerHTML = 'เวลาที่สอน';
                        itemDivSubjectSelect.appendChild( tmpPlaceHolder );
                        for(var i=0; i < times.length; i++){
                            var tmpOption = document.createElement('option');
                            tmpOption.setAttribute('value', i );
                            tmpOption.innerHTML = times[i];
                            if( tmpPersistObj.timeofday === i ){
                                tmpOption.setAttribute('selected', true);
                            }
                            itemDivSubjectSelect.appendChild( tmpOption );
                        }
                        //TEXT UNIT OF SUBJECT
                        var itemDivUnitSubject = document.createElement('div');
                        itemDivUnitSubject.style.display = 'inline-block';
                        itemDivUnitSubject.style.marginRight = '10px';
                        itemDivUnitSubject.style.marginLeft = '15px';
                        itemDiv.appendChild( itemDivUnitSubject );
                        //
                        var itemDivUnitnput = document.createElement('input');
                        itemDivUnitnput.className = 'form-control';
                        itemDivUnitnput.id = 'item' + index + '_unitNumber';
                        itemDivUnitnput.style.paddingTop = '4px';
                        itemDivUnitnput.setAttribute('type', 'text');
                        itemDivUnitnput.style.width = '80px';
                        itemDivUnitnput.setAttribute('placeholder', 'หน่วยกิจ');
                        if (tmpPersistObj.credit) itemDivUnitnput.setAttribute('value', tmpPersistObj.credit);
                        itemDivUnitnput.onkeypress = function(evt){
                            return isNumber(evt);
                        };
                        itemDivUnitSubject.appendChild( itemDivUnitnput );
                        //TEXT TEACHER
                        var itemDivTeacher = document.createElement('div');
                        itemDivTeacher.style.display = 'inline-block';
                        itemDivTeacher.style.marginRight = '10px';
                        itemDiv.appendChild( itemDivTeacher );
                        //
                        var itemDivTeacherInput = document.createElement('input');
                        itemDivTeacherInput.className = 'form-control';
                        itemDivTeacherInput.id = 'item' + index + '_teacher';
                        itemDivTeacherInput.style.paddingTop = '4px';
                        itemDivTeacherInput.setAttribute('type', 'text');
                        itemDivTeacherInput.style.width = '140px';
                        itemDivTeacherInput.setAttribute('placeholder', 'ชื่ออาจารย์ผู้สอน');
                        if (tmpPersistObj.instructor) itemDivTeacherInput.setAttribute('value', tmpPersistObj.instructor);
                        itemDivTeacher.appendChild( itemDivTeacherInput );
                        //TEXT MINIMUM NUMBER TO OPEN
                        var itemDivMinNumber = document.createElement('div');
                        itemDivMinNumber.style.display = 'inline-block';
                        itemDivMinNumber.style.margin = '5px 10px 5px 0px';
                        itemDivMinNumber.style.width = '65px';
                        itemDiv.appendChild( itemDivMinNumber );
                        //TEXT NUMBER SUPPORT
                        var itemDivNumberSupport = document.createElement('div');
                        itemDivNumberSupport.style.display = 'inline-block';
                        itemDivNumberSupport.style.marginRight = '10px';
                        itemDivNumberSupport.style.width = '65px';
                        itemDiv.appendChild( itemDivNumberSupport );
                        //
                        var itemDivNumberSupportInput = document.createElement('input');
                        itemDivNumberSupportInput.className = 'form-control';
                        itemDivNumberSupportInput.id = 'item' + index + '_numberSupport';
                        itemDivNumberSupportInput.style.paddingTop = '4px';
                        itemDivNumberSupportInput.setAttribute('type', 'text');
                        itemDivNumberSupportInput.setAttribute('placeholder', '#สูงสุด');
                        if (tmpPersistObj.maxstudent) itemDivNumberSupportInput.setAttribute('value', tmpPersistObj.maxstudent);
                        itemDivNumberSupportInput.onkeypress = function(evt){
                            return isNumber(evt);
                        };
                        itemDivNumberSupport.appendChild( itemDivNumberSupportInput );
                        //
                        var itemDivMinNumberInput = document.createElement('input');
                        itemDivMinNumberInput.className = 'form-control';
                        itemDivMinNumberInput.id = 'item' + index + '_minNumber';
                        itemDivMinNumberInput.style.paddingTop = '4px';
                        itemDivMinNumberInput.setAttribute('type', 'text');
                        itemDivMinNumberInput.setAttribute('placeholder', '#ขั้นต่ำ');
                        if (tmpPersistObj.minstudent) itemDivMinNumberInput.setAttribute('value', tmpPersistObj.minstudent);
                        itemDivMinNumber.appendChild( itemDivMinNumberInput );
                        itemDivMinNumberInput.onkeypress = function(evt){
                            return isNumber(evt);
                        };
                        //CHECKBOX 'REQUIRED' SUBJECT?
                        var itemDivIsRequired = document.createElement('div');
                        itemDivIsRequired.style.display = 'inline-block';
                        itemDivIsRequired.style.marginTop = '2px';
                        itemDivIsRequired.style.width = '100px';
                        itemDivIsRequired.style.verticalAlign = 'top';
                        itemDivIsRequired.style.textAlign ='left';
                        itemDiv.appendChild( itemDivIsRequired );
                        //
                        var itemDivIsRequiredInput = document.createElement('input');
                        itemDivIsRequiredInput.className = 'form-control';
                        itemDivIsRequiredInput.id = 'item' + index + '_isRequired';
                        itemDivIsRequiredInput.setAttribute('type', 'checkbox');
                        itemDivIsRequiredInput.style.width = '15px';
                        itemDivIsRequiredInput.style.display = 'inline-block';
                        if( tmpPersistObj.isRequired === 1 ){
                            itemDivIsRequiredInput.setAttribute('checked', true);
                        }
                        itemDivIsRequired.appendChild( itemDivIsRequiredInput );
                        //
                        var itemDivIsRequiredLabel = document.createElement('div');
                        itemDivIsRequiredLabel.style.display = 'inline-block';
                        itemDivIsRequiredLabel.innerHTML = 'วิชาบังคับ?';
                        itemDivIsRequiredLabel.style.marginTop = '9px';
                        itemDivIsRequiredLabel.style.marginLeft = '4px';
                        itemDivIsRequiredLabel.style.verticalAlign = 'top';
                        itemDivIsRequired.appendChild( itemDivIsRequiredLabel );
                        //
                        index++;
                    }
                });
                $('.selectpicker').selectpicker();
                //BLUE AREA
                /*
                 * semester_state
                 * 0 -- created but not open for enrollment AND not scheduled
                 * 1 -- created and open for enrollment (either by schedule or manual -- will be known by var status)
                 * 2 -- enrollment is done. Selection already took place
                 *
                 * status
                 * 0 -- no meaning
                 * 1 -- schedule is created
                 * 2 -- schedule was run
                */
                if( classOfSemesterObj && typeof( classOfSemesterObj['mincredit'] ) !== 'undefined' && typeof( classOfSemesterObj['maxcredit'] ) !== 'undefined' && typeof( classOfSemesterObj['pickmethod_id'] ) !== 'undefined'){
                    $('#minUnitTerm').val( classOfSemesterObj['mincredit'] );
                    $('#maxUnitTerm').val( classOfSemesterObj['maxcredit'] );
                    var semesterCheckbox = true;
                    if (classOfSemesterObj.semester_state === 1){
                        semesterCheckbox = true;
                        $('#manageActive').css('display', '');
                    } else if (classOfSemesterObj.semester_state === 3) { 
                        semesterCheckbox = true;
                        $('#manageActive').css('display', '');
                        //FILL-IN OPEN/END PERIOD HERE @gie
                        if (classOfSemesterObj.status == 1) {
                            //schedule is created
                            var optionsRadios = document.getElementsByName('optionsRadios');
                            optionsRadios[1].checked = true;
                            $('#closePeriod').parent().css('display','inline-block');
                            $('input[value="option2"]').css('margin-top', '10px');

                            $('#openPeriod')[0].value = parseSqlDateToJSFormat(classOfSemesterObj.startdate.date);
                            $('#closePeriod')[0].value = parseSqlDateToJSFormat(classOfSemesterObj.finishdate.date);
                        } else {
                            //at this point, it can be only 2
                        }
                    } else {
                        semesterCheckbox = false;
                        $('#manageActive').css('display', 'none');
                    }
                    $('#semesterState').attr('checked', semesterCheckbox);

                    $('#methodPicker').children().each(function(){
                        if( parseInt($(this).val()) === classOfSemesterObj['pickmethod_id'] ){
                            $(this).attr('selected', 'true');
                        }
                    });
                    $('.selectpicker').selectpicker('refresh');
                }
                //
                $('#step1Area').fadeOut(10);
                $('#step2Area').fadeIn(300);
            }
        }
    
        //WHEN SUBMIT
        function onSubmitSubject(){
            var idMethod = '#methodPicker';
            var idMinUnitTerm = '#minUnitTerm';
            var idMaxUnitTerm = '#maxUnitTerm';
            var idSemesterState = '#semesterState:checked';
            var semesterCheckbox = "0";
            if (typeof $(idSemesterState).val() !== "undefined"){
                semesterCheckbox = "1";
            }
            var idStartPeriod = '#openPeriod';
            var idEndPeriod = '#closePeriod';
            //alert( $(idStartPeriod).val() + ', ' + $(idEndPeriod).val() );
            var startDate = '';
            var endDate = '';

            var isActiveNow = 0;
            var optionsRadios = document.getElementsByName('optionsRadios');
            if (optionsRadios[0].checked) {
                isActiveNow = 2;
            } else if (optionsRadios[1].checked) {
                isActiveNow = 1;
                semesterCheckbox = 3;
                startDate = $('#openPeriod')[0].value;
                endDate = $('#closePeriod')[0].value;
            }

            var jsonObj = { 
                'subjectsdata' : [],
                'classof_id' :  $('#studentYear').val(),
                'semester' :  $('#studentSemester').val(),
                'mincredit' : $(idMinUnitTerm).val(),
                'maxcredit' : $(idMaxUnitTerm).val(),
                'semester_state' : semesterCheckbox,
                'pickermethod' : $(idMethod).val(),
                'isActiveNow' : isActiveNow,
                'startDate' : startDate,
                'endDate' : endDate
            };
            //
            $('#step2Area').children().first().children().each( function(index){
                var idTextSubject = '#item' + index + '_subject';
                var idDate = '#item' + index + '_date';
                var idTime = '#item' + index + '_time';
                var idUnitNumber = '#item' + index + '_unitNumber';
                var idTeacher = '#item' + index + '_teacher';
                var idNumSupport = '#item' + index + '_numberSupport';
                var idNumMin = '#item' + index + '_minNumber';
                var idIsRequired = '#item' + index + '_isRequired';
                var isRequiredValue = function(){
                    if ($(idIsRequired).is(':checked')) {
                        return 1;
                    }else{
                        return 0;
                    }
                };
                //
                var tmpObj = {
                    "subject_id": $(idTextSubject).parent().attr('subjectId'),
                    "dayofweek": $(idDate).val(),
                    "timeofday": $(idTime).val(),
                    "credit": $(idUnitNumber).val(),
                    "instructor": $(idTeacher).val(),
                    "minstudent": $(idNumMin).val(),
                    "maxstudent": $(idNumSupport).val(),
                    "isRequired": isRequiredValue()
                }
                //
                //[GIE] for subject_id I still use TEXT because I don't know the real id. We can change after I can get subject_id
                jsonObj['subjectsdata'].push(tmpObj);
            } );
            console.log( JSON.stringify( jsonObj ) );  
            //THEN SEND THIS DATA TO WEB SERVICE
            enrollSubjectsToDatabase( jsonObj );
        }
        
        //
        function enrollSubjectsToDatabase(jsonObj){
            var jsonString = JSON.stringify( jsonObj );
            //[GIE] we will change service location here
            var urlStr = window.location.origin + '/server/admin_api.php/api/v1/subject/submit';
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: urlStr,
                dataType: 'json',
                data: jsonString,
                contentType: "text/plain; charset=UTF-8",
                success: function(data, textStatus, jqXHR){
                    document.getElementById('import-success').style.display = 'block';
                    document.getElementById('import-warning').style.display = 'none';
                    document.getElementById('reloadAgain').style.display = 'block';
                    document.getElementById('buttonArea').style.display = 'none';
                },
                error: function(jqXHR, textStatus, errorThrown){
                    window.console.log('enroll subject error: ' + textStatus);
                    document.getElementById('import-success').style.display = 'none';
                    document.getElementById('import-warning').style.display = 'block';
                    document.getElementById('reloadAgain').style.display = 'none';
                    document.getElementById('buttonArea').style.display = 'block';
                }
            });
        }
        
        //
        function getStudentClassList(){
            var urlStr = window.location.origin + '/server/admin_api.php/api/v1/classof/list';
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: urlStr,
                dataType: 'json',
                contentType: "text/plain; charset=UTF-8",
                success: function(data, textStatus, jqXHR){                   
                    $('#studentYear').empty();
                    $('#studentYear').append( "<option value='' selected disabled>รุ่นนิสิต</option>");
                    for(var i=0; i< data.length; i++){
                        if( $.trim(data[i]['classof_description']) !== 'Admin' && data[i]['classof_id'] !== 1 ){ //FILTER OUT 'Admin' ITEM
                            $('#studentYear').append( "<option value='" + data[i]['classof_id'] + "'>" + data[i]['classof_description'] +'</option>' );
                        }
                    }
                    $('.selectpicker').selectpicker('refresh');
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert('get Student Class error: ' + textStatus);
                }
            });
        }
        
        //
        function getSubjectList(){
            if( $('#studentYear').val() === null || $('#studentSemester').val() === null ){
                alert('Please select criteria first');
            }
            else{
                var urlStr = window.location.origin + '/server/admin_api.php/api/v1/subject/list';
                var jsonObj = {
                    'classof_id': $('#studentYear').val(),                  //1
                    'semester': $('#studentSemester').val()             //4
                };
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    url: urlStr,
                    data: JSON.stringify( jsonObj ),
                    dataType: 'json',
                    contentType: "text/plain; charset=UTF-8",
                    success: function(data, textStatus, jqXHR){
                        subjectList = [];
                        subjectListId = [];
                        subjectListObj = data[0]['subjectsdata'];
                        classOfSemesterObj = data[1]['classofsemester'][0];
                        for(var i=0; i<subjectListObj.length; i++){
                            subjectList.push( subjectListObj[i].name );
                            subjectListId.push( subjectListObj[i].id );
                        }
                        //GENERATE SUBJECT ITEMS
                        queryFromCriteria();
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert('get Subject error: ' + textStatus);
                    }
                });
            }
        }
        
        //
        function getPickMethodList(){
            var urlStr = window.location.origin + '/server/admin_api.php/api/v1/enrollmentadmin/listpickmethod';
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: urlStr,
                dataType: 'json',
                contentType: "text/plain; charset=UTF-8",
                success: function(data, textStatus, jqXHR){
                    $('#methodPicker').empty();
                    $('#methodPicker').append( "<option value='' selected disabled>วิธีที่ใช้ตัดสินกรณีไม่ลงตัว</option>");
                    for(var i=0; i< data.length; i++){
                        $('#methodPicker').append( "<option value='" + data[i]['pickmethod_id'] + "'>" + data[i]['name'] +'</option>' );
                    }
                    $('.selectpicker').selectpicker('refresh');
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert('get Pick Method error: ' + textStatus);
                }
            });
        }
        
        //
        function selectAllFunction(){

            $('#sortableMain').empty();
            $('#selectedZone').empty();

            for(var i =0; i < subjectList.length; i++){
                var tmpLiElement = document.createElement('li');
                tmpLiElement.innerHTML = '[' + $.trim(subjectListObj[i].subject_id) + ']-' +subjectList[ i ];
                tmpLiElement.setAttribute('tmpSelected', subjectListObj[ i ].selected);
                tmpLiElement.setAttribute('subjectId', $.trim(subjectListObj[i].subject_id));
                $('#sortableMain').append( tmpLiElement );
            }
            //
            //ADD <UL> LANDING ITEMS
            var selectedZoneElement = document.getElementById('selectedZone');
            var initialNum = 5;
            for( var i=0; i< initialNum; i++){
                var tmpUIElement =  document.createElement('ul');
                tmpUIElement.id = 'sortable' + i;
                tmpUIElement.className = 'connectedSortable';
                tmpUIElement.style.padding = '0px';
                tmpUIElement.style.marginBottom = '0px';
                selectedZoneElement.appendChild( tmpUIElement );
            }
            
            //BIND DRAG/SORABLE EVENT
            $( '.connectedSortable' ).sortable({
                connectWith: ".connectedSortable",
                stop: function( event, ui) {
                    //SUPPORT SWAP
                    var parentElement = event.toElement.parentElement;
                    if( parentElement.childElementCount > 1 && parentElement.id !== 'sortableMain' ){
                        for( var i=0; i< parentElement.childElementCount; i++ ){
                            if( event.toElement.innerHTML !== parentElement.children[ i ].innerHTML ){
                                event.target.appendChild( parentElement.children[i] );
                                break;
                            }
                        }
                    }
                    
                    var countSelectedItem = countSelectedItemText();
                    if( $('#selectedZone').children().length <= countSelectedItem ){
                        var tmpUIElement =  document.createElement('ul');
                        tmpUIElement.id = 'sortable' + (countSelectedItem+1) ;
                        tmpUIElement.className = 'connectedSortable';
                        tmpUIElement.style.padding = '0px';
                        tmpUIElement.style.marginBottom = '0px';
                        $('#selectedZone').append( tmpUIElement );
                        //ACTIVATE FOR NEW ITEM ADDED
                        $( '.connectedSortable' ).sortable({
                            connectWith: ".connectedSortable"
                        }).disableSelection();
                    }
                },
                receive: function(){
                    countSelectedItemText();
                }
            }).disableSelection();
            
            //SELECT ALL
            var indexMove = 0;
            while( indexMove < $('#sortableMain').children().length ){
                var countSelectedItem = countSelectedItemText();
                if( $('#selectedZone').children().length <= countSelectedItem ){
                    var tmpUIElement =  document.createElement('ul');
                    tmpUIElement.id = 'sortable' + (countSelectedItem+1) ;
                    tmpUIElement.className = 'connectedSortable';
                    tmpUIElement.style.padding = '0px';
                    tmpUIElement.style.marginBottom = '0px';
                    $('#selectedZone').append( tmpUIElement );
                    //ACTIVATE FOR NEW ITEM ADDED
                    $( '.connectedSortable' ).sortable({
                        connectWith: ".connectedSortable"
                    }).disableSelection();
                }
                //
                for( var i=0; i < $('#selectedZone').children().length; i++ ){
                    if( ! $('#selectedZone').children()[i].hasChildNodes() ){
                        $('#selectedZone').children()[i].appendChild( $('#sortableMain').children()[ indexMove ] );
                        break;
                    }
                }
                indexMove = 0;
            }//END WHILE
        }
    
        //
        function clearFunction(){
            $('#selectedZone').children().each(function(){
                if( $(this).has('li').length > 0 ){
                    $('#sortableMain').append( $(this).children()[0] );
                }
            });
        }

        function parseSqlDateToJSFormat(dateInput) {
            //2015-05-02 16:09:34.747
            var dateSplit = dateInput.split(' ');
            var sdate = dateSplit[0].split('-');
            var stime = dateSplit[1].substr(0,5);
            
            return sdate[0] + '/' + sdate[1] + '/' + sdate[2] + ' ' + stime;
        }

    </script>
  
    </body>
</html>
